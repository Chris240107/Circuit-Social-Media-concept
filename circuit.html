<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit | Decentralized Social</title>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- PeerJS for Real P2P Chat -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --bg-body: #09090b;
            --bg-card: rgba(24, 24, 27, 0.7);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --accent: #6366f1; /* Indigo */
            --accent-glow: rgba(99, 102, 241, 0.4);
            --danger: #ef4444;
            --warning: #eab308;
            --success: #22c55e;
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            --border: rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, var(--bg-body) 60%);
            min-height: 100vh;
        }

        /* --- LAYOUT GRID --- */
        .layout {
            display: grid;
            grid-template-columns: 250px 600px 350px;
            max-width: 1200px;
            margin: 0 auto;
            gap: 20px;
            padding-top: 20px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed;
            width: 250px;
            height: 100vh;
            padding: 20px;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo i { color: var(--accent); }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            font-size: 1.1rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.3s;
            border-radius: 12px;
        }
        .nav-item:hover, .nav-item.active {
            color: var(--accent);
            background: var(--bg-glass);
        }

        /* --- MAIN FEED --- */
        .main-feed {
            grid-column: 2;
            padding-bottom: 100px;
        }

        /* Create Post Box */
        .create-post {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-input-area {
            display: flex;
            gap: 15px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #333, #555);
            object-fit: cover;
        }

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            outline: none;
            font-size: 1.1rem;
            min-height: 80px;
            padding-top: 10px;
        }

        /* Risk Meter & Tools */
        .post-tools {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }

        .risk-wrapper {
            flex: 1;
            margin-right: 20px;
        }

        .risk-bar-bg {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .risk-bar-fill {
            height: 100%;
            width: 0%;
            transition: 0.5s ease;
            background: var(--success);
        }

        .risk-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .toggle-anon {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-right: 15px;
            user-select: none;
        }
        
        .toggle-switch {
            width: 40px;
            height: 20px;
            background: #333;
            border-radius: 20px;
            position: relative;
            transition: 0.3s;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-anon.active .toggle-switch { background: var(--accent); }
        .toggle-anon.active .toggle-switch::after { transform: translateX(20px); }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 0 15px var(--accent-glow);
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Feed Posts */
        .post-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: 0.2s;
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .post-info h4 { font-size: 0.95rem; }
        .post-info span { font-size: 0.8rem; color: var(--text-muted); }
        .anon-badge {
            background: #333;
            color: #aaa;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        .post-content {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        .post-stats {
            display: flex;
            justify-content: space-between;
            color: var(--text-muted);
            font-size: 0.9rem;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .stat-item {
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stat-item:hover.like { color: #f91880; }
        .stat-item:hover.comment { color: var(--accent); }

        .comments-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            display: none;
        }
        .comments-section.open { display: block; }
        .comment {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        /* --- RIGHT SIDEBAR (Chat) --- */
        .right-sidebar {
            grid-column: 3;
            padding-top: 20px;
        }
        
        .chat-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
            border-radius: 16px 16px 0 0;
        }

        .connection-panel {
            padding: 15px;
            background: #111;
            font-size: 0.8rem;
        }
        .connection-panel input {
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 5px;
            margin: 5px 0;
            border-radius: 4px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        .msg-me { align-self: flex-end; background: var(--accent); color: white; }
        .msg-them { align-self: flex-start; background: #333; color: #ddd; }

        .chat-input-box {
            padding: 10px;
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--border);
        }
        .chat-input-box input {
            flex: 1;
            background: #222;
            border: none;
            padding: 8px;
            border-radius: 20px;
            color: white;
            outline: none;
        }

        /* --- LOGIN MODAL --- */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: #18181b;
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--border);
            text-align: center;
            width: 400px;
        }
        .login-input {
            width: 100%;
            padding: 12px;
            background: #27272a;
            border: 1px solid #3f3f46;
            border-radius: 8px;
            color: white;
            margin: 20px 0;
            font-size: 1rem;
        }

        @media (max-width: 1000px) {
            .layout { grid-template-columns: 80px 1fr; }
            .sidebar { width: 80px; }
            .nav-text, .logo span { display: none; }
            .right-sidebar { display: none; } /* Hide chat on tablet initially */
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-overlay">
        <div class="login-box">
            <h1 style="color:var(--accent); margin-bottom: 10px;">CIRCUIT</h1>
            <p style="color:var(--text-muted)">Enter the grid.</p>
            <input type="text" id="username-input" class="login-input" placeholder="Choose your Handle">
            <button class="btn-primary" style="width:100%" onclick="login()">Enter System</button>
        </div>
    </div>

    <div class="layout">
        
        <!-- SIDEBAR -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fa-solid fa-microchip"></i>
                <span>CIRCUIT</span>
            </div>
            <div class="nav-item active">
                <i class="fa-solid fa-house"></i>
                <span class="nav-text">Feed</span>
            </div>
            <div class="nav-item">
                <i class="fa-solid fa-hashtag"></i>
                <span class="nav-text">Explore</span>
            </div>
            <div class="nav-item">
                <i class="fa-solid fa-bell"></i>
                <span class="nav-text">Alerts</span>
            </div>
            <div class="nav-item" onclick="toggleChatPanel()">
                <i class="fa-solid fa-envelope"></i>
                <span class="nav-text">Messages</span>
            </div>
            <div class="nav-item" style="margin-top: auto;">
                <i class="fa-solid fa-user"></i>
                <span id="sidebar-username" class="nav-text">Profile</span>
            </div>
        </nav>

        <!-- MAIN FEED -->
        <main class="main-feed">
            
            <!-- Post Creator -->
            <div class="create-post">
                <div class="post-input-area">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" class="avatar" id="my-avatar">
                    <textarea id="post-text" placeholder="What's happening in the grid?"></textarea>
                </div>
                
                <div class="post-tools">
                    <div class="risk-wrapper">
                        <div class="risk-text">
                            <span id="risk-status">AI Risk Meter: Idle</span>
                            <span id="risk-score">0%</span>
                        </div>
                        <div class="risk-bar-bg">
                            <div class="risk-bar-fill" id="risk-fill"></div>
                        </div>
                    </div>

                    <div class="toggle-anon" id="anon-toggle" onclick="toggleAnon()">
                        <div class="toggle-switch"></div>
                        <span>Incognito</span>
                    </div>

                    <button class="btn-primary" id="btn-post" onclick="createPost()">POST</button>
                </div>
            </div>

            <!-- Feed Stream -->
            <div id="feed-stream">
                <!-- Posts will be injected here via JS -->
            </div>
        </main>

        <!-- RIGHT SIDEBAR (CHAT) -->
        <aside class="right-sidebar">
            <div class="chat-container">
                <div class="chat-header">
                    <h4><i class="fa-solid fa-lock"></i> Encrypted P2P Link</h4>
                </div>
                
                <div class="connection-panel">
                    <div>Your ID: <span id="my-peer-id" style="color:var(--accent); cursor:pointer;">Loading...</span></div>
                    <div style="margin-top:10px; font-size: 0.7rem; color:#888;">Send this ID to your friend.</div>
                    
                    <div style="border-top:1px solid #333; margin-top:10px; padding-top:10px;">
                        <input type="text" id="remote-peer-id" placeholder="Enter Friend's ID here...">
                        <button class="btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="connectToPeer()">Connect</button>
                    </div>
                    <div id="conn-status" style="color: var(--success); margin-top: 5px; font-size: 0.8rem;"></div>
                </div>

                <div class="chat-messages" id="chat-box">
                    <div style="text-align:center; color:#555; font-size:0.8rem; margin-top:20px;">
                        Wait for connection to start chatting.
                    </div>
                </div>

                <div class="chat-input-box">
                    <input type="text" id="chat-input" placeholder="Secure message...">
                    <button class="btn-primary" style="border-radius:50%; width:35px; height:35px; padding:0; display:flex; align-items:center; justify-content:center;" onclick="sendP2PMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </aside>

    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // !!! IMPORTANT: Get a key from https://aistudio.google.com/app/apikey for real AI !!!
        const GEMINI_API_KEY = "AIzaSyCfR3Ir8kWPvXiaWO4_Mmtow1OlItj8yWE"; // Paste your key inside the quotes. Example: "AIzaSy..."
        
        let currentUser = {
            name: "User",
            handle: "@user",
            avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
            isIncognito: false
        };

        const toxicWords = ['hate', 'stupid', 'kill', 'attack', 'idiot', 'scam']; // Fallback if API key missing
        
        // --- 2. LOGIN SYSTEM ---
        function login() {
            const input = document.getElementById('username-input').value;
            if(input.trim().length > 0) {
                currentUser.name = input;
                currentUser.handle = "@" + input.toLowerCase().replace(/\s/g, '');
                currentUser.avatar = `https://api.dicebear.com/7.x/avataaars/svg?seed=${input}`;
                
                document.getElementById('sidebar-username').innerText = currentUser.name;
                document.getElementById('my-avatar').src = currentUser.avatar;
                document.getElementById('login-overlay').style.display = 'none';
                
                // Initialize Fake Feed
                generateFakePosts();
            }
        }

        // --- 3. POST & FEED SYSTEM ---
        function toggleAnon() {
            const toggle = document.getElementById('anon-toggle');
            toggle.classList.toggle('active');
            currentUser.isIncognito = toggle.classList.contains('active');
            
            const btn = document.getElementById('btn-post');
            btn.innerText = currentUser.isIncognito ? "POST ANONYMOUSLY" : "POST";
        }

        async function checkRisk(text) {
            // Real AI Integration with Fallback
            if(GEMINI_API_KEY.length > 10) {
                try {
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${AIzaSyCfR3Ir8kWPvXiaWO4_Mmtow1OlItj8yWE}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            contents: [{
                                parts: [{text: `Analyze the toxicity of this social media post on a scale of 0 to 100. Return ONLY the number. Post: "${text}"`}]
                            }]
                        })
                    });
                    const data = await response.json();
                    const score = parseInt(data.candidates[0].content.parts[0].text);
                    return isNaN(score) ? 0 : score;
                } catch(e) {
                    console.error("Gemini Error:", e);
                    return simpleCheck(text); // Fallback
                }
            } else {
                return simpleCheck(text); // Fallback if no key
            }
        }

        function simpleCheck(text) {
            let score = 0;
            text = text.toLowerCase();
            toxicWords.forEach(word => { if(text.includes(word)) score += 30; });
            return Math.min(score, 100);
        }

        // Debounce for typing
        let timeout = null;
        document.getElementById('post-text').addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(async () => {
                const text = this.value;
                if(!text) return;
                
                document.getElementById('risk-status').innerText = "Analyzing...";
                const score = await checkRisk(text);
                updateRiskUI(score);
            }, 600);
        });

        function updateRiskUI(score) {
            const bar = document.getElementById('risk-fill');
            const scoreTxt = document.getElementById('risk-score');
            const status = document.getElementById('risk-status');
            const btn = document.getElementById('btn-post');

            bar.style.width = score + "%";
            scoreTxt.innerText = score + "%";

            if(score < 30) {
                bar.style.background = "var(--success)";
                status.innerText = "Risk: Safe";
                btn.disabled = false;
            } else if (score < 70) {
                bar.style.background = "var(--warning)";
                status.innerText = "Risk: Moderate";
                btn.disabled = false;
            } else {
                bar.style.background = "var(--danger)";
                status.innerText = "Risk: DANGEROUS";
                btn.disabled = true; // Block posting
            }
        }

        function createPost() {
            const text = document.getElementById('post-text').value;
            if(!text) return;

            const postData = {
                name: currentUser.isIncognito ? "Anonymous" : currentUser.name,
                handle: currentUser.isIncognito ? "#" + Math.random().toString(16).substr(2,6) : currentUser.handle,
                avatar: currentUser.isIncognito ? "https://api.dicebear.com/7.x/identicon/svg?seed=" + Math.random() : currentUser.avatar,
                content: text,
                time: "Just now",
                likes: 0,
                comments: [],
                risk: parseInt(document.getElementById('risk-score').innerText)
            };

            addPostToFeed(postData, true);
            document.getElementById('post-text').value = "";
            updateRiskUI(0);
        }

        function addPostToFeed(data, prepend = false) {
            const feed = document.getElementById('feed-stream');
            const div = document.createElement('div');
            div.className = 'post-card';
            
            // Generate unique ID for comment toggling
            const postId = 'post-' + Math.floor(Math.random() * 100000);

            let badge = data.risk > 0 ? `<span class="anon-badge" style="color:${data.risk > 50 ? 'red' : 'orange'}">Risk: ${data.risk}%</span>` : '';

            div.innerHTML = `
                <div class="post-header">
                    <img src="${data.avatar}" class="avatar">
                    <div class="post-info">
                        <h4>${data.name} ${data.name === 'Anonymous' ? '<span class="anon-badge">INC</span>' : ''}</h4>
                        <span>${data.handle} â€¢ ${data.time} ${badge}</span>
                    </div>
                </div>
                <div class="post-content">${data.content}</div>
                <div class="post-stats">
                    <div class="stat-item like" onclick="likePost(this)">
                        <i class="fa-regular fa-heart"></i> <span>${data.likes}</span>
                    </div>
                    <div class="stat-item comment" onclick="toggleComments('${postId}')">
                        <i class="fa-regular fa-comment"></i> <span>${data.comments.length}</span>
                    </div>
                    <div class="stat-item">
                        <i class="fa-solid fa-share-nodes"></i>
                    </div>
                </div>
                
                <!-- Comments Section -->
                <div class="comments-section" id="${postId}">
                    <div class="comment-input" style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="text" placeholder="Reply..." style="flex:1; background:#222; border:none; padding:5px; color:white; border-radius:4px;" onkeydown="addComment(event, this)">
                    </div>
                    <div class="comments-list">
                        ${data.comments.map(c => `
                            <div class="comment">
                                <strong>${c.user}:</strong> <span>${c.text}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            if(prepend) feed.prepend(div);
            else feed.appendChild(div);
        }

        // --- 4. INTERACTIONS (Mock) ---
        function likePost(el) {
            const icon = el.querySelector('i');
            const count = el.querySelector('span');
            
            if(icon.classList.contains('fa-regular')) {
                icon.classList.remove('fa-regular');
                icon.classList.add('fa-solid');
                count.innerText = parseInt(count.innerText) + 1;
            } else {
                icon.classList.remove('fa-solid');
                icon.classList.add('fa-regular');
                count.innerText = parseInt(count.innerText) - 1;
            }
        }

        function toggleComments(id) {
            const section = document.getElementById(id);
            section.classList.toggle('open');
        }

        function addComment(e, input) {
            if(e.key === 'Enter' && input.value) {
                const list = input.parentElement.nextElementSibling;
                const div = document.createElement('div');
                div.className = 'comment';
                div.innerHTML = `<strong>${currentUser.name}:</strong> <span>${input.value}</span>`;
                list.prepend(div);
                input.value = '';
                
                // Update counter
                const countSpan = input.closest('.post-card').querySelectorAll('.stat-item span')[1];
                countSpan.innerText = parseInt(countSpan.innerText) + 1;
            }
        }

        function generateFakePosts() {
            const fakes = [
                { name: "Sarah Connor", handle: "@sarah_c", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sarah", content: "The AI moderation on this app is actually kind of scary. It knows when I'm angry before I do.", time: "2h ago", likes: 45, comments: [{user: "John", text: "True that."}], risk: 10 },
                { name: "Anonymous", handle: "#8f3a21", avatar: "https://api.dicebear.com/7.x/identicon/svg?seed=8f3a21", content: "Just saw the new Cyberpunk update. It's glitchy but beautiful. Just like this world.", time: "4h ago", likes: 120, comments: [], risk: 0 },
                { name: "Crypto King", handle: "@btc_lord", avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=King", content: "Market is crashing! Everyone panic sell now! This is the end!", time: "5h ago", likes: 12, comments: [{user: "Bot", text: "Risk detected."}], risk: 85 }
            ];
            fakes.forEach(p => addPostToFeed(p));
        }

        // --- 5. REAL P2P CHAT (PeerJS) ---
        // This creates a direct connection between browsers
        
        let peer = null;
        let conn = null;

        // Initialize Peer
        setTimeout(() => {
            peer = new Peer(null, {
                debug: 2
            });

            peer.on('open', function(id) {
                document.getElementById('my-peer-id').innerText = id;
            });

            peer.on('connection', function(c) {
                // When someone connects to ME
                conn = c;
                setupConnection();
            });
        }, 1000);

        function connectToPeer() {
            const remoteId = document.getElementById('remote-peer-id').value;
            if(!remoteId) return alert("Enter an ID");
            
            // Connect to THEM
            conn = peer.connect(remoteId);
            setupConnection();
        }

        function setupConnection() {
            document.getElementById('conn-status').innerText = "Connected! Encryption Active.";
            
            conn.on('data', function(data) {
                addMessage(data, 'them');
            });
            
            conn.on('open', function(){
                document.getElementById('conn-status').innerText = "Link Established.";
                document.getElementById('chat-box').innerHTML = ""; // Clear waiting msg
            });
        }

        function sendP2PMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            
            if(msg && conn && conn.open) {
                conn.send(msg); // Send to peer
                addMessage(msg, 'me'); // Show on my screen
                input.value = '';
            } else {
                alert("Not connected to a friend yet!");
            }
        }

        function addMessage(msg, who) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg-bubble msg-${who}`;
            div.innerText = msg;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

    </script>
</body>
</html>
